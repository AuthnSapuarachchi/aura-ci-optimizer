# 403 Forbidden Error - Complete Fix

## Problem
When users log in successfully but get a 403 error when trying to upload logs:
```
POST https://aura-spring-backend-1.onrender.com/api/v1/log/upload 403 (Forbidden)
Error: Upload failed (403): Unknown error
```

## Root Causes

1. **CORS Configuration Too Restrictive**
   - Backend only allowed exact domain matches
   - Vercel may assign different subdomains (e.g., `project-xyz123.vercel.app`)
   
2. **Preflight OPTIONS Requests Failing**
   - Browser sends OPTIONS request before POST
   - Backend wasn't properly handling these

3. **JWT Token Not Being Passed Through Security Chain**
   - Security filters might be blocking before authentication completes

## Complete Fix Applied

### 1. Backend CORS Configuration (`WebConfig.java`)

**Before:**
```java
.allowedOrigins(
    "http://localhost:5173",
    "https://aura-ci-optimizer.vercel.app"
)
```

**After:**
```java
.allowedOriginPatterns(
    "http://localhost:*",
    "https://*.vercel.app",
    "https://*.netlify.app"
)
```

This allows ANY subdomain from Vercel/Netlify.

### 2. Added Dedicated CORS Filter (`CorsFilter.java`)

New file that:
- Runs BEFORE all other filters (highest precedence)
- Handles OPTIONS preflight requests
- Dynamically sets CORS headers based on request origin
- Allows all necessary headers for JWT authentication

### 3. Enhanced Logging

Added debug output to:
- `JwtAuthenticationFilter.java` - Shows token validation process
- `LogUploadController.java` - Shows authentication status

This helps diagnose issues in Render logs.

### 4. Frontend Error Handling (`Dashboard.jsx`)

Updated to:
- Log when token is present
- Show more detailed error messages
- Not auto-logout on CORS errors (only on auth errors)

## Deployment Steps

### Backend (Render)

1. **Commit changes:**
   ```bash
   git add .
   git commit -m "Fix CORS 403 error for log upload"
   git push origin main
   ```

2. **Deploy on Render:**
   - Go to Render dashboard
   - Select `aura-spring-backend-1`
   - Click "Manual Deploy" → "Deploy latest commit"
   - Wait ~5-10 minutes

3. **Verify deployment:**
   - Check Render logs for startup messages
   - Look for "Started BackendApplication in X seconds"

### Frontend (Vercel)

Frontend doesn't need redeployment - changes are all in backend.

But if you made frontend changes:

1. **Commit:**
   ```bash
   git add .
   git commit -m "Update error handling"
   git push origin main
   ```

2. **Vercel auto-deploys from main branch**

## Testing After Deployment

### Test Sequence:

1. **Clear browser cache and cookies**
   - This ensures you're using fresh tokens

2. **Login**
   ```
   ✓ Should succeed
   ✓ Token should be stored in localStorage
   ✓ Dashboard should load
   ✓ Previous logs should display
   ```

3. **Upload Log**
   ```
   ✓ Paste test log text
   ✓ Click "Analyze Log"
   ✓ Should see success (not 403)
   ✓ New log should appear in table
   ```

### Sample Log for Testing:
```
[INFO] BUILD SUCCESS
[INFO] Total time: 45.2 s
[INFO] Finished at: 2025-11-18T10:30:00Z
```

## Checking Render Logs

After deploying, when you test upload:

```
=== JWT Filter ===
Request URI: /api/v1/log/upload
Auth Header: Present
JWT Token extracted: eyJhbGciOiJIUzI1Ni...
Username from token: youruser
User loaded: youruser
Token is valid, authenticating user
User authenticated successfully

=== Upload Log Endpoint ===
Authentication object: Present
Authentication principal type: com.authnaura.backend.model.User
Current user: youruser
Log text length: 123
```

If you see this, authentication is working!

## Still Not Working?

### Check 1: Token Expiration
- Logout and login again
- JWT tokens expire (check JwtService.java for expiration time)

### Check 2: Different Vercel URL
- Your actual URL might be different
- Check browser address bar
- Add it explicitly to WebConfig.java if needed:
  ```java
  .allowedOriginPatterns(
      "http://localhost:*",
      "https://*.vercel.app",
      "https://your-specific-app.vercel.app"  // Add this
  )
  ```

### Check 3: MongoDB Connection
- Verify backend can connect to MongoDB
- Check Render logs for connection errors
- Verify `SPRING_DATA_MONGODB_URI` environment variable

### Check 4: Python Service
- Verify ML service is running
- Check `PYTHON_SERVICE_URL` environment variable
- Log upload might fail if ML service is down

## Production Cleanup

Once everything works, remove debug logging:

1. Remove all `System.out.println` statements
2. Replace with proper SLF4J logging:
   ```java
   private static final Logger log = LoggerFactory.getLogger(ClassName.class);
   log.debug("Message here");
   ```

## Architecture Overview

```
Frontend (Vercel)
    ↓ POST /api/v1/log/upload
    ↓ Headers: Authorization: Bearer <token>
    ↓
Backend (Render) - Port 8080
    ↓ CorsFilter (handles OPTIONS)
    ↓ JwtAuthenticationFilter (validates token)
    ↓ SecurityFilterChain (checks authorization)
    ↓ LogUploadController
    ↓
ML Service (Render) - Flask
    ↓ Analyzes log text
    ↓ Returns status & duration
    ↓
MongoDB Atlas
    ↓ Stores log analysis
```

## Files Changed

✅ `backend/src/main/java/com/authnaura/backend/config/WebConfig.java`
✅ `backend/src/main/java/com/authnaura/backend/config/CorsFilter.java` (NEW)
✅ `backend/src/main/java/com/authnaura/backend/config/JwtAuthenticationFilter.java`
✅ `backend/src/main/java/com/authnaura/backend/controller/LogUploadController.java`
✅ `frontend/src/components/Dashboard.jsx`

## Success Criteria

✓ Login works
✓ Dashboard loads with previous logs
✓ Can paste log text
✓ Click "Analyze Log" → Success response
✓ New log appears in table
✓ No 403 errors in browser console
✓ No auto-logout after upload

---

**Next:** Deploy backend to Render and test!
